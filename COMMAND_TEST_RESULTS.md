# JVInit() ハング問題 - 調査結果レポート

**日時**: 2025-11-17  
**問題**: `JVInit()` 呼び出し時に無限ハング  
**影響**: すべてのデータ取得処理が実行不可

---

## 試行した解決策（すべて失敗）

### 1. サービスキー設定方法の変更
- ❌ `JVSetServiceKey()` API使用 → エラー-100 → ハング  
- ❌ レジストリ経由設定 + 0.5秒待機 → ハング  
- ❌ サービスキー設定なし（レジストリから読み込み）→ ハング  

### 2. 実装バージョンの変更
- ❌ 新実装（レジストリ+フォールバック）→ ハング  
- ❌ 旧実装（8ba4824コミット、過去成功版）→ ハング  

### 3. COM初期化方法の変更
- ❌ デフォルト初期化（`Dispatch()`のみ）→ ハング  
- ❌ 明示的STAスレッド初期化（`CoInitialize()`）→ ハング  

### 4. JVLinkAgentサービス操作
- ✅ サービス停止・再起動 → サービスは正常だがJVInit()は依然ハング  

---

## 環境確認結果

| 項目 | 状態 | 詳細 |
|------|------|------|
| Python | ✅ OK | 32-bit Python 3.10.11（JV-Link互換） |
| JVLinkAgentサービス | ✅ RUNNING | 正常動作中 |
| サービスキー（レジストリ） | ✅ 設定済み | \`1UJC-VRFM-24YD-K2W4-4\` |
| COMオブジェクト作成 | ✅ 成功 | \`Dispatch('JVDTLab.JVLink')\` 正常 |
| JVInit()呼び出し | ❌ ハング | 30秒以上応答なし |

---

## 過去セッションとの比較

### 過去の成功例（会話サマリーより）
- **データロード実績**: 81,860レコード、29/38テーブル  
- **使用コミット**: 8ba4824以前（「レジストリーを使わない実装」前）  
- **JVInit()**: 正常に動作  

### 現在のセッション
- **データロード実績**: 0レコード（JVInit()が実行できない）  
- **使用コミット**: 最新版（8ba4824以降の変更を含む）  
- **JVInit()**: 全パターンでハング  

### 重要な発見
コミット \`8ba4824\` で**「レジストリーを使わない実装」**に変更されましたが、旧実装に戻してもハングは解消されませんでした。つまり、**問題はコードの変更ではなく、環境側にある可能性が高い**です。

---

## 推定原因

1. **JV-Link DLLの破損または不整合**  
   - JVLinkAgent.exeとJVDTLab.JVLink COMの間で不整合  

2. **サービスキーの有効期限切れ**  
   - レジストリには存在するが、JRA-VANサーバー側で無効化されている可能性  

3. **Windowsアップデートによる互換性問題**  
   - 32bit COM APIの動作が変わった可能性  

4. **未知のシステム状態問題**  
   - 過去のセッションから何かが変わった  

---

## 推奨アクション

### 優先度1: JV-Link の再インストール
1. JV-Linkの完全アンインストール  
2. システム再起動  
3. JV-Linkの再インストール  
4. JRA-VAN DataLabでサービスキーを手動設定  
5. 動作確認  

### 優先度2: JRA-VAN サポートへの問い合わせ
- JV-Link APIのJVInit()がハングする症状を報告  
- サービスキーの有効性を確認  

### 優先度3: 代替手段の検討
- VBScript/VBAでJVInit()が動作するか確認  
- 別のPCでテスト実行  

---

## 結論

**JVInit()のハング問題は、Pythonコードの問題ではなく、JV-Link環境またはシステム設定に起因する可能性が非常に高い**です。

過去のセッションでは同じコードが正常に動作していたこと、旧実装に戻してもハングが解消されないことから、**環境側の変化（Windowsアップデート、JV-Linkの状態変化、サービスキーの無効化など）**が原因と推測されます。

**作成**: 2025-11-17 10:05 JST
